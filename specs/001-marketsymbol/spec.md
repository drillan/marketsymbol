# Feature Specification: 統一シンボルフォーマットとベンダーアダプター

**Feature Branch**: `001-marketsymbol`
**Created**: 2026-02-05
**Status**: Draft
**Input**: User description: "drafts/symbol-format-spec.mdをもとに仕様を定義。複数ベンダのデータソースでも統一されたコードを提供するためのアダプタ機能を含む"

## Clarifications

### Session 2026-02-05

- Q: 週次限月フォーマット `YYYYMM-W` は同一週内の金曜/水曜を区別できない問題がある。どう解決するか？ → A: 全て `YYYYMMDD` 形式に統一（ADR-002で決定）
- Q: 月次限月も `YYYYMMDD` に統一すべきか？ → A: 統一する。全ての限月を `YYYYMMDD` 形式（8桁）で表現（ADR-002を更新）
- Q: SQ日の取得方法は？ → A: 別ライブラリ `marketsched` から取得する（自前計算しない）
- Q: 対応言語は？ → A: Python と Rust の両方をサポート（marketschema と同様）

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 統一シンボルフォーマットでの金融商品識別 (Priority: P1)

開発者が金融市場データを扱う際、異なる取引所や資産クラス（株式、先物、オプション）の商品を、一貫した形式で識別できる。`XJPX:7203`（トヨタ自動車）や`XJPX:NK:20250314:F`（日経225先物 2025年3月限）のような統一フォーマットで商品を特定できる。

**Why this priority**: これがシステム全体の基盤。統一シンボルなしには、アダプター変換もベンダー間のデータ統合もできない。

**Independent Test**: シンボル文字列を作成・パースし、資産クラスを正しく判定できることで検証可能。単体でシンボル管理機能を提供する。

**Acceptance Scenarios**:

1. **Given** 株式シンボル文字列 "XJPX:7203", **When** パースを実行, **Then** 取引所=XJPX, 証券コード=7203, 資産クラス=equity が取得される
2. **Given** 先物シンボル文字列 "XJPX:NK:20250314:F", **When** パースを実行, **Then** 取引所=XJPX, 商品コード=NK, 限月=20250314, 資産クラス=future が取得される
3. **Given** オプションシンボル文字列 "XJPX:N225O:20250314:C:42000", **When** パースを実行, **Then** 取引所=XJPX, 商品コード=N225O, 限月=20250314, オプション種別=C, 権利行使価格=42000, 資産クラス=option が取得される
4. **Given** 週次オプションシンボル文字列 "XJPX:N225MW:20250110:C:41000", **When** パースを実行, **Then** 取引所=XJPX, 商品コード=N225MW, 限月=20250110, オプション種別=C, 権利行使価格=41000, 資産クラス=option が取得される
5. **Given** 小文字を含むシンボル "xjpx:7203", **When** 正規化処理を実行, **Then** 大文字変換された "XJPX:7203" が返される
6. **Given** 全角文字を含むシンボル "ＸＪＰＸ：７２０３", **When** 正規化処理を実行, **Then** 半角変換された "XJPX:7203" が返される

---

### User Story 2 - シンボルのバリデーション (Priority: P1)

開発者が不正なシンボル文字列を検出し、適切なエラーメッセージを取得できる。形式エラー（セグメント数不正、無効な取引所コード）や論理エラー（無効な限月、先物への権利行使価格指定）を明確に識別できる。

**Why this priority**: データ品質保証の基盤。不正データの早期検出がシステム信頼性に直結する。

**Independent Test**: 様々な不正シンボルを入力し、適切なエラーコードとメッセージが返されることで検証可能。

**Acceptance Scenarios**:

1. **Given** 無効な取引所コード "XXXX:7203", **When** バリデーション実行, **Then** エラーコード E007「不明な取引所コードです」が返される
2. **Given** 先物に権利行使価格を指定 "XJPX:NK:20250314:F:42000", **When** バリデーション実行, **Then** エラーコード E001「先物には権利行使価格を指定できません」が返される
3. **Given** オプションに権利行使価格なし "XJPX:N225O:20250314:C", **When** バリデーション実行, **Then** エラーコード E002「オプション（C/P）には権利行使価格が必須です」が返される
4. **Given** 無効な日付の限月 "XJPX:NK:20250332:F", **When** バリデーション実行, **Then** エラーコード E005「無効な日付です」が返される
5. **Given** 限月が8桁でない "XJPX:NK:202503:F", **When** バリデーション実行, **Then** エラーコード E003「無効な限月形式です（8桁YYYYMMDDで指定してください）」が返される

---

### User Story 3 - ベンダー固有シンボルから統一シンボルへの変換 (Priority: P2)

開発者が各データベンダー（証券会社、データプロバイダー）固有のシンボル形式から統一シンボルフォーマットに変換できる。例えば、あるベンダーが「7203.T」（東証トヨタ）を使用している場合、アダプターを通じて「XJPX:7203」に正規化できる。

**Why this priority**: 複数ベンダー対応がシステムの拡張性と実用性を決定する。P1の基盤機能の上に構築される。

**Independent Test**: 特定ベンダーのアダプターを実装し、そのベンダー形式のシンボルが統一形式に変換できることで検証可能。

**Acceptance Scenarios**:

1. **Given** ベンダーAのアダプターが登録済み, **When** ベンダーA形式のシンボル "7203.T" を変換, **Then** 統一シンボル "XJPX:7203" が返される
2. **Given** 複数ベンダーのアダプターが登録済み, **When** ベンダー名を指定してシンボル変換を要求, **Then** 適切なアダプターが選択され変換が実行される
3. **Given** 未登録のベンダー名, **When** シンボル変換を要求, **Then** 「登録されていないベンダーです」エラーが返される
4. **Given** ベンダーB形式の先物シンボル "NK25_202503" と marketsched から取得したSQ日, **When** 変換実行, **Then** 統一シンボル "XJPX:NK:20250314:F" が返される

---

### User Story 4 - 統一シンボルからベンダー固有シンボルへの逆変換 (Priority: P2)

開発者がシステム内部で使用している統一シンボルを、特定ベンダーのAPI呼び出しに必要な形式に変換できる。注文執行時やデータ取得時に、ベンダーが期待する形式でシンボルを送信できる。

**Why this priority**: 双方向変換により、データ取得（受信）だけでなく注文発注（送信）にも対応できる。

**Independent Test**: 統一シンボルを各ベンダー固有形式に変換し、元のベンダー形式と一致することで検証可能。

**Acceptance Scenarios**:

1. **Given** 統一シンボル "XJPX:7203" とベンダーAのアダプター, **When** 逆変換を実行, **Then** ベンダーA形式 "7203.T" が返される
2. **Given** 統一シンボル "XJPX:NK:20250314:F" とベンダーBのアダプター, **When** 逆変換を実行, **Then** ベンダーB形式 "NK25_202503" が返される
3. **Given** ベンダーがサポートしない資産クラスのシンボル, **When** 逆変換を実行, **Then** 「このベンダーはこの資産クラスをサポートしていません」エラーが返される

---

### User Story 5 - marketschemaとの統合 (Priority: P3)

marketsymbolをmarketschemaライブラリと連携させ、Instrumentモデルのsymbolフィールドで統一シンボルフォーマットを使用できる。marketschemaのBaseAdapterを拡張してシンボル変換機能を組み込める。

**Why this priority**: 既存エコシステムとの統合。先にコア機能（P1、P2）を完成させてからの統合が効率的。

**Independent Test**: marketschemaのInstrumentモデルを作成する際に統一シンボルを使用し、正しくバリデーションされることで検証可能。

**Acceptance Scenarios**:

1. **Given** 統一シンボル "XJPX:7203", **When** marketschemaのInstrumentモデルを作成, **Then** symbolフィールドに正しく格納され、バリデーションをパスする
2. **Given** marketsymbolアダプターを拡張したベンダーアダプター, **When** 外部データをInstrumentに変換, **Then** symbolフィールドが統一フォーマットで自動設定される

---

### Edge Cases

- 空文字列のシンボルが入力された場合：バリデーションエラーを返す
- ISO 10383に存在しないが形式的に正しいMICコード（4文字英大文字）が入力された場合：設定に基づき許可または警告
- 存在しない商品コード（NK, NKMなど定義済みコード以外）が入力された場合：設定に基づき許可または警告
- 過去の限月（既に満期を迎えた先物・オプション）のシンボル：許可（履歴データ用途）
- 未来すぎる限月（例：10年後）のシンボル：許可（限月の合理性チェックはスコープ外）
- 権利行使価格が0または負の数の場合：バリデーションエラーを返す
- シリーズ識別用オプション（"O" サフィックス）：正しくパースされる
- 土日や祝日の日付が限月として指定された場合：形式的には許可（取引日検証はスコープ外）
- marketsched が利用できない場合：SQ日を含むシンボル生成はエラーを返す

## Requirements *(mandatory)*

### Functional Requirements

#### シンボルフォーマット基本機能

- **FR-001**: システムは株式・ETFシンボル形式 `[取引所]:[証券コード]` をパースできること
- **FR-002**: システムは先物シンボル形式 `[取引所]:[商品コード]:[限月]:F` をパースできること（限月は8桁YYYYMMDD）
- **FR-003**: システムは権利行使価格付きオプションシンボル形式 `[取引所]:[商品コード]:[限月]:[C/P]:[権利行使価格]` をパースできること（限月は8桁YYYYMMDD）
- **FR-004**: システムは権利行使価格なしオプションシンボル形式（シリーズ識別用） `[取引所]:[商品コード]:[限月]:O` をパースできること
- **FR-005**: システムはパース結果から資産クラス（equity/future/option）を判定できること

#### 限月フォーマット

- **FR-006**: システムは全ての限月を `YYYYMMDD` 形式（8桁）で統一的に認識できること

#### バリデーション

- **FR-007**: システムは取引所コードがISO 10383 MIC形式（4文字英大文字）であることを検証できること
- **FR-008**: システムは商品コードが2-6文字の英数字であることを検証できること
- **FR-009**: システムは限月が有効な日付（8桁YYYYMMDD）であることを検証できること
- **FR-010**: システムは先物シンボルに権利行使価格が指定された場合にエラーを返すこと
- **FR-011**: システムはコール(C)/プット(P)オプションシンボルに権利行使価格が未指定の場合にエラーを返すこと
- **FR-012**: システムはエラーコード（E001-E007）を伴う明確なエラーメッセージを返すこと

#### 正規化

- **FR-013**: システムは入力シンボルを大文字に変換できること
- **FR-014**: システムは入力シンボルの前後の空白を除去できること
- **FR-015**: システムは全角文字（コロン、数字）を半角に変換できること

#### シンボル生成

- **FR-016**: システムは株式・ETFシンボルを構成要素から生成できること
- **FR-017**: システムは先物シンボルを構成要素から生成できること
- **FR-018**: システムはオプションシンボルを構成要素から生成できること
- **FR-019**: システムは年月指定から月次先物/オプションシンボルを生成できること（SQ日は外部ライブラリ `marketsched` から取得）

#### アダプター機能

- **FR-020**: システムはベンダー固有シンボルから統一シンボルへの変換アダプターを定義できること
- **FR-021**: システムは統一シンボルからベンダー固有シンボルへの逆変換を定義できること
- **FR-022**: システムはアダプターをベンダー名で登録・取得できること
- **FR-023**: システムは登録済みアダプター一覧を取得できること
- **FR-024**: アダプターはサポートする資産クラスを宣言できること

#### derivatives-reaper互換機能

- **FR-025**: システムは derivatives-reaper 形式（`YYYYMM`, `YYYYMM-W`）の限月を marketsymbol 形式（`YYYYMMDD`）に変換できること
- **FR-026**: システムは marketsymbol 形式（`YYYYMMDD`）の月次限月を derivatives-reaper 形式（`YYYYMM`）に変換できること

### Key Entities

- **Symbol（シンボル）**: 金融商品を一意に識別する文字列。取引所コード、商品/証券コード、限月、オプション種別、権利行使価格の要素で構成される
- **EquitySymbol（株式シンボル）**: 株式・ETFを識別。取引所コードと証券コードで構成
- **FutureSymbol（先物シンボル）**: 先物を識別。取引所コード、商品コード、限月（YYYYMMDD）で構成
- **OptionSymbol（オプションシンボル）**: オプションを識別。取引所コード、商品コード、限月（YYYYMMDD）、オプション種別、権利行使価格で構成
- **Expiry（限月）**: 満期日を表す8桁の日付（YYYYMMDD形式）
- **SymbolAdapter（シンボルアダプター）**: ベンダー固有形式と統一形式間の変換ロジックを定義
- **AdapterRegistry（アダプターレジストリ）**: ベンダー名によるアダプターの登録・検索を管理

## Technical Constraints

### 対応言語

- **Python**: Python 3.13以上
- **Rust**: 最新安定版

### プロジェクト構成

marketschema と同様のモノレポ構成を採用：

```
marketsymbol/
├── python/           # Python実装
│   ├── src/
│   │   └── marketsymbol/
│   ├── tests/
│   └── pyproject.toml
├── rust/             # Rust実装
│   ├── src/
│   ├── tests/
│   └── Cargo.toml
├── specs/            # 仕様書
└── docs/             # ドキュメント
```

### 言語間の一貫性

- 両言語で同一のシンボルフォーマット仕様を実装
- 同一のバリデーションルールとエラーコード
- 同一のテストケースで動作検証
- API設計は各言語のイディオムに従いつつ、概念的な一貫性を維持

## Assumptions

- 取引所コードはISO 10383 MICに準拠するが、未登録のMICコードでも形式が正しければ許可する（新興取引所対応）
- 商品コードの一覧（NK, NKM, NKMI, TP, TPM, N225O, N225MW, TPXO等）は参考として提供されるが、システムは定義済みコード以外も許可する（将来の商品追加対応）
- 日本市場は`XJPX`に統一する（XTKS, XOSEは使用しない）
- 権利行使価格は正の整数とする（小数点対応は将来拡張）
- 暗号資産・FX・債券のフォーマットは本仕様のスコープ外（将来拡張可能な設計とする）
- **全ての限月は `YYYYMMDD` 形式（8桁）に統一する**（ADR-002で決定）
  - 月次限月: SQ日（第2金曜日）を明示（例: `20250314`）
  - 週次限月: 具体的な日付を指定（例: `20250110`）
  - `YYYYMM` / `YYYYMM-W` 形式は非推奨とし、変換関数で対応
- 取引日検証（土日祝日チェック）はスコープ外
- **SQ日の取得は外部ライブラリ `marketsched` に委譲する**（自前計算しない）
  - `marketsched` はJPXの公式SQ日一覧（https://www.jpx.co.jp/markets/derivatives/special-quotation/index.html）を一次情報として使用
  - `marketsched` が利用できない場合、SQ日を必要とする機能はエラーを返す
- **Python と Rust の両方で実装する**（marketschema と同様のアプローチ）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 開発者は10行以内のコードで任意のシンボル文字列をパースし、構成要素を取得できる（Python/Rust両方）
- **SC-002**: 100%の有効なシンボル文字列が正しくパースされる（ドラフト仕様に記載の全例を含む、両言語で同一結果）
- **SC-003**: 無効なシンボル文字列は100%検出され、適切なエラーコードとメッセージが返される（両言語で同一エラーコード）
- **SC-004**: 新規ベンダーアダプターの実装が50行以内のコードで完了できる（Python/Rust各々）
- **SC-005**: シンボルのパース・バリデーション処理が1ミリ秒以内に完了する（両言語）
- **SC-006**: marketschemaのInstrumentモデルと統合した際、既存のバリデーション機能と競合しない（Python/Rust各々）
- **SC-007**: 同一テストケースがPythonとRustの両方でパスする

## Dependencies

- **marketsched**: SQ日（特別清算指数算出日）の取得に使用。オプショナル依存として、インストールされていない場合はSQ日関連機能が無効化される
  - Python: `marketsched` パッケージ
  - Rust: `marketsched` crate

## References

- [ADR-001: シンボル仕様](../../docs/adr/symbol/001-symbol-specification.md)
- [ADR-002: 限月フォーマットの統一](../../docs/adr/symbol/002-weekly-expiry-format.md)
- [JPX SQ日一覧](https://www.jpx.co.jp/markets/derivatives/special-quotation/index.html)
- [marketschema](https://github.com/drillan/marketschema) - Python/Rust両対応の参考実装
